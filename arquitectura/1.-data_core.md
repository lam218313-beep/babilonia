Documento de Arquitectura de Software Módulo 01: Núcleo de Datos (Data Core) Versión: 1.0 Tecnología Base: Google Vertex AI / Gemini File Search API Función Principal: Gestión de Contexto, Recuperación Semántica y Fuente de Génesis.
1. Visión General El Data Core no es una base de datos pasiva; es el sistema de inteligencia fundamental que alimenta a los agentes superiores. Su responsabilidad es doble:
Fuente de Génesis: Proveer la "personalidad normativa" necesaria para crear al Orquestador Dinámico.
Fuente de Verdad: Proveer respuestas técnicas precisas y referencias cruzadas durante la ejecución del expediente técnico.
Se elimina el uso de Bases de Datos Vectoriales externas (Pinecone/Milvus) en favor de la infraestructura nativa de Google Gemini File Search, optimizando latencia de gestión y costos de infraestructura.
2. Arquitectura de Almacenamiento (Logical Stores) La información se segrega en contenedores lógicos ("Stores") dentro de Gemini para maximizar la precisión de recuperación y evitar alucinaciones por contaminación de contexto.
A. Store "Genesis & Methodology" (Metodología) Contenido: Normas ISO 19650, Guías BIM nacionales, Manuales de procesos internos del estudio, Plantillas de BEP (BIM Execution Plan).
Objetivo: Alimentar al Agente Constructor para definir cómo se gestionará el proyecto.
Usuarios: Motor 2 (Fase Génesis).
B. Store "Regulatory Framework" (Normativa RNE) Contenido: Reglamento Nacional de Edificaciones (Perú) segmentado (E.030, E.060, IS.010, EM.020, A.010), Normas de Minsa (Salud), Minedu (Educación), etc.
Objetivo: Definir las restricciones legales de qué se puede construir.
Usuarios: Motor 2 (Supervisor), Motor 3 (Modulador).
C. Store "Atomic Specs" (Especificaciones Técnicas) Contenido: Fichas técnicas de materiales (Sika, Aceros Arequipa, etc.), Tablas de dosificación, Catálogos de proveedores, Rendimientos de mano de obra.
Objetivo: Proveer datos numéricos y precisos para cálculos y memorias descriptivas.
Usuarios: Motor 4 (Ejecutor).
D. Store "Project Context" (Dinámico) Contenido: Archivos específicos del proyecto actual (Levantamiento topográfico, Estudio de Suelos, Parámetros Urbanísticos, Anteproyecto).
Nota: Este Store se crea y destruye con cada proyecto.
3. Componentes del Sistema (Backend) El Data Core se expone como un microservicio (API REST) con los siguientes sub-componentes internos:
3.1. Pipeline de Ingesta (The Librarian) Proceso automatizado para cargar nueva información al sistema.
Módulo Sanitizador (Python):
Librería: PyMuPDF o pdfminer.
Acción: Elimina encabezados repetitivos, pies de página con números irrelevantes y páginas en blanco para reducir consumo de tokens.
Módulo de Etiquetado Semántico (LLM-Based):
Acción: Antes de subir un archivo, un modelo Gemini-Flash lee la primera página y renombra el archivo digitalmente siguiendo una convención estricta:
[ CATEGORIA][ CODIGO] [ TITULO_RESUMIDO]_[ AÑO].pdf
Ejemplo: ESTRUCTURAS_E060_CONCRETO_ARMADO_2024.pdf
3.2. Middleware de Consulta (The Router) Es el cerebro del Data Core que recibe las preguntas de los otros motores.
Analizador de Intención: Detecta si la pregunta requiere una búsqueda simple o una inferencia compleja.
Ruteo Multi-Store:
Si la pregunta es: "¿Qué tubería uso para una montante en un hospital?"
El Router consulta simultáneamente:
Store B (Norma Salud): Para requisitos de asepsia.
Store C (Catálogo): Para diámetros comerciales disponibles.
Sintetiza ambas respuestas antes de devolverlas al Orquestador.
3.3. Sistema de Caché (Redis) Almacena respuestas a preguntas frecuentes invariables (ej. "Recubrimiento mínimo en zapatas según E.060") para evitar llamadas API costosas y repetitivas.
4. Flujos de Datos (Data Flow) Flujo 
1: La Génesis del Orquestador Input: Usuario solicita "Nuevo Colegio en Puno".
Router: Identifica palabras clave "Colegio" (Tipología) y "Puno" (Ubicación).
Consulta: Activa Store A (Metodología) y Store B (Normas Minedu + Normas Clima Frío).
Output: Devuelve al Motor 2 un paquete JSON con las "Reglas de Juego" para ese proyecto específico.
Flujo 2: Consulta de Compatibilización (Cross-Check) Input: Motor Ejecutor envía: "Muro de Corte de 15cm en Zona Sísmica 4".
Router: Entiende que es una validación crítica.
Consulta: Busca en Store B (Norma E.030 Sismo).
Razonamiento: La IA interna del Data Core evalúa el hallazgo.
Output: Retorna: "ALERTA: La norma E.030 prohíbe muros portantes de menos de 25cm en Zona 4 para edificaciones esenciales."
5. Stack Tecnológico Sugerido Lenguaje: Python 3.11+
Framework API: FastAPI (por su velocidad y manejo asíncrono).
IA Engine: Google Vertex AI SDK (Gemini 1.5 Pro para razonamiento, Gemini Flash para etiquetado rápido).
Storage: Google Cloud Storage (Bucket temporal para subidas) + Vertex AI File Stores (Indexación) Actualmente lo haremos en local.
Cache: Redis.

6. Diseño de Interfaz y UX (Página Única del Data Core)

Objetivo
- Proveer, en una sola página, todos los elementos necesarios para: consultar multi-store con evidencia citada, gestionar ingestas (sanitización, etiquetado, publicación), controlar caché, auditar respuestas y administrar el Store Dinámico de Contexto de Proyecto.

Roles y contexto
- Personas: Curador/Librarian (aprueba y publica), Operador (Orquestador/Modulador/Ejecutor), Admin (operaciones y seguridad).
- Contexto activo: Proyecto, Ubicación, Tipología, y selección del Store D (Contexto de Proyecto) cuando aplique.

Estructura general (layout de una sola página)
- Encabezado (barra superior):
	- Proyecto activo, Ambiente (Dev/Prod), Perfil de consulta (Estricto/Exploratorio).
	- Búsqueda rápida, botón primario "Consultar", botón secundario "Ingestar".
	- Indicadores: latencia total, estado de caché (hit/miss), request_id/correlation.
- Lateral izquierdo (filtros persistentes):
	- Selección de Stores (A/B/C/D) con conteos y estado.
	- Filtros: jurisdicción, año/edición, vigencia (vigente/derogada), proveedor.
	- Presets de intención: Lookup, Cross-check, Synthesis, Genesis.
- Zona de trabajo (panel central con secciones colapsables):
	- Sección 1: Consulta.
	- Sección 2: Ingesta.
	- Sección 3: Auditoría/Observabilidad.
	- Sección 4: Caché y Control.
	- Sección 5: Contexto de Proyecto (Store D).

Sección 1: Consulta (The Router)
- Constructor de consulta:
	- Campo "Pregunta", selector de intención (Lookup/Cross-check/Synthesis/Genesis).
	- Selección de Stores a consultar, top-k por store, "Evidencia estricta" (citas obligatorias), idioma de respuesta, formato de salida (Markdown/JSON).
	- Contexto del proyecto (ubicación, tipología, variables clave) con autocompletado desde Store D; opción de "Adjuntar archivo temporal".
- Resultado y evidencia:
	- Panel de Respuesta con badges: confianza, severidad (ALERTA/INFO), timestamp.
	- Lista de citas: norma (código), artículo/sección, ancla (página/heading-id), acciones "Copiar cita" y "Abrir fuente".
	- Visor de documento a la derecha con resaltado del fragmento citado.
	- Cobertura multi-store: chips por Store con % aportado y documentos relevantes.
- Controles de workflow:
	- "Guardar como FAQ", "Enviar al Orquestador", "Adjuntar al Paquete del Modulador", "Guardar en Contexto de Proyecto".
	- Toggle "Reintentar con mayor recall" (MMR/umbral).
- Trazabilidad:
	- Pasos del plan (retrieve → rank → merge → resolve → cite), tiempos por etapa, request_id.

Sección 2: Ingesta (The Librarian)
- Dropzone de archivos (PDF, DOCX, CSV) y lista de pendientes.
- Previsualización y sanitización:
	- Vistas de páginas, remoción de encabezados/pies, páginas en blanco.
	- Diff antes/después.
- Etiquetado semántico y renombrado:
	- Sugerencia automática (Gemini Flash) con campos editables: categoría, código, título resumido, año, jurisdicción.
	- Nombre propuesto: "[CATEGORIA]_[CODIGO]_[TITULO]_[AÑO].pdf".
	- Clasificación del Store destino (A/B/C/D).
- Anclas y metadatos:
	- Extracción de secciones (títulos), artículos, referencias.
	- Hash de contenido, versión, effective_date, revoked_by.
- Curaduría y publicación:
	- Estado por archivo: Pendiente → En revisión → Aprobado → Publicado.
	- Botón "Publicar" con registro (quién/cuándo/cambios) e invalidación selectiva de caché.
- Deduplicación y versionado:
	- Detección de duplicados por hash/similarity, vínculo a versión previa, vista de diff.

Sección 3: Auditoría y Observabilidad
- Tabla de consultas recientes: usuario, intención, stores usados, latencia, cache hit/miss, severidad, resultado.
- Timeline de una consulta: métricas por fase, decisiones del planificador, documentos consultados.
- Descarga de trazas (JSON) para soporte/debugging.

Sección 4: Caché y Control
- Estado del caché: tasa de aciertos, tamaño, TTL por corpus.
- Búsqueda de claves recientes, ver TTL restante, invalidación por etiqueta (p.ej., E.030) o por documento.
- Reindexar store y reconstrucción de índices locales (modo offline).

Sección 5: Contexto de Proyecto (Store D)
- Crear/Snapshot/Restaurar/Eliminar el Store D del proyecto.
- Subida de archivos de contexto (topografía, suelos, parámetros), metadatos sensibles con cifrado.
- Variables del proyecto visibles/editables (ubicación, clima, altitud) con control de versión.
- Exportar resumen de contexto a "Reglas de Juego" (para Génesis del Orquestador).

Interacciones clave
- Consultar con evidencia:
	- Escribir pregunta → elegir intención → ejecutar → revisar respuesta y citas → abrir visor y validar → enviar a otros motores o guardar.
- Ingesta segura:
	- Soltar archivo → sanitizar → etiquetar/renombrar → anclas → curaduría → publicar → invalidar caché.
- Cross-check crítico:
	- Seleccionar intención "Cross-check", activar "Evidencia estricta", revisar severidad y artículos citados, emitir alerta con guía de remediación.
- Gestión del Store D:
	- Snapshot antes de cambios, subir nuevos estudios, actualizar variables; todo rastreado.

Estados vacíos y errores
- Vacío: mensajes guiados con tips y ejemplos; botones de demo.
- Errores: mensajes accionables (reintentar, revisar permisos, reducir alcance), mostrar request_id y logs resumidos.

Accesibilidad y rendimiento
- Atajos: Enter (consultar), Ctrl+U (subir), Ctrl+I (publicar), Ctrl+K (buscar comandos).
- Navegación por teclado, alto contraste, etiquetas claras (códigos normativos).
- Operaciones largas con toasts y colas; cancelación segura de jobs.

Seguridad y permisos
- Acceso por rol y por Store; cambios de ingesta requieren curador.
- Redacción de PII en previsualizaciones; cifrado para Store D.

Métricas de producto
- Latencia p95 por etapa, tasa de cache hit, % de consultas con evidencia completa, tasa de rechazo en curaduría, errores de etiquetado, uso por intención.

Sub-sección: Chat de Consulta (Independiente del Workflow)
- Objetivo: Habilitar consultas ad‑hoc sobre los mismos Stores (A/B/C/D) y el mismo Router, sin modificar el estado del proyecto ni el Store D, con evidencia citada y trazabilidad completa.
- Alcance y memoria:
	- Solo lectura: no publica, no ingesta, no altera variables del proyecto.
	- Memoria opcional por "conversation_id" con TTL configurable; persistencia sólo si el usuario guarda explícitamente una respuesta (FAQ o adjuntar al paquete).
	- Modo Regulatorio: "Evidencia estricta" obligatoria para normativa (citas con artículo/sección y ancla).
- UX (integración en la página única):
	- Toggle "Chat" en la barra superior, junto a "Consultar".
	- Panel de conversación a la izquierda (historial y mensajes), Respuesta + Citas al centro, Visor de documento a la derecha.
	- Controles rápidos en el panel: intención (Lookup/Cross‑check/Synthesis/Genesis), Stores, top‑k, "Evidencia estricta", idioma, formato (Markdown/JSON).
	- Acciones: "Guardar como FAQ", "Adjuntar al Paquete del Modulador", "Enviar al Orquestador", "Guardar en Contexto" (requiere confirmación porque es sólo lectura por defecto).
- API mínima del chat:
	- POST /chat/ask: { conversation_id?, message, intent?, stores?, top_k?, strict_citation?, context_snapshot? } → { answer, citations[], documents[], confidence, request_id }.
	- GET /chat/history/{conversation_id}: → { messages[], citations[] }.
	- POST /chat/suggest: { last_message } → { suggestions[] }.
	- Reglas: Para Regulatory Framework, usar strict_citation=true; siempre devolver request_id y pasos del plan.
- Evidencia y escalamiento:
	- Mostrar anclas (código de norma, artículo/sección, página/heading-id), abrir visor contextual y copiar cita.
	- Botón de escalamiento: "Enviar al Orquestador/Modulador" cuando la conversación derive en una tarea formal.